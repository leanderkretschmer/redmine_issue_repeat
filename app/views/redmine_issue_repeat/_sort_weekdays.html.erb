<% 
  # View Hook für die Issue-Anzeige, um die Sortierung der Wochentage zu korrigieren
  weekday_cf = IssueCustomField.find_by(name: 'Intervall Wochentag')
  return unless weekday_cf
  weekday_cf_id = weekday_cf.id
%>

<script type="text/javascript">
(function() {
  function sortWeekdays() {
    <% if weekday_cf_id %>
    // Definiere die richtige Reihenfolge
    var weekdayOrder = {
      'Montag': 1,
      'Dienstag': 2,
      'Mittwoch': 3,
      'Donnerstag': 4,
      'Freitag': 5,
      'Samstag': 6,
      'Sonntag': 7
    };
    
    // Suche sowohl Tabellen- als auch Definitionslisten-Strukturen
    var valueCell = null;
    // 1) Table row per CF id
    var row = document.querySelector('tr.issue_custom_field_<%= weekday_cf_id %>');
    if (row) {
      valueCell = row.querySelector('td.value, td:last-child');
    }
    // 2) Fallback: Suche nach Label-Text und nehme die Nachbarzelle
    if (!valueCell) {
      var ths = document.querySelectorAll('table#attributes th');
      ths.forEach(function(th){
        var t = (th.textContent || '').trim();
        if (!valueCell && t.indexOf('Intervall Wochentag') !== -1) {
          var td = th.nextElementSibling;
          if (td) valueCell = td;
        }
      });
    }
    // 3) Fallback: Definition list (dt/dd)
    if (!valueCell) {
      var dts = document.querySelectorAll('dt');
      dts.forEach(function(dt){
        var t = (dt.textContent || '').trim();
        if (!valueCell && t.indexOf('Intervall Wochentag') !== -1) {
          var dd = dt.nextElementSibling;
          if (dd) valueCell = dd;
        }
      });
    }
    if (!valueCell) return;

    var text = (valueCell.textContent || valueCell.innerText || '').replace(/\u00A0/g, ' ');
    if (!text || text.trim() === '') return;
    
    // Parse Werte
    var values = text.split(',').map(function(v) { return v.trim(); }).filter(function(v) { return v; });
    if (values.length <= 1) return;
    
    // Sortiere
    var sorted = values.slice().sort(function(a, b) {
      return (weekdayOrder[a] || 999) - (weekdayOrder[b] || 999);
    });
    
    // Aktualisiere nur wenn nötig
    var newText = sorted.join(', ');
    if (newText !== text.trim()) {
      // Ersetze Text oder einzelne Chips/Spans, falls vorhanden
      if (valueCell.querySelectorAll('span').length > 0) {
        // Falls Redmine Themes die Werte in Spans rendern
        valueCell.innerHTML = sorted.map(function(v){ return '<span>' + v + '</span>'; }).join(', ');
      } else {
        valueCell.textContent = newText;
      }
    }
    <% end %>
  }
  
  // Ausführen
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(sortWeekdays, 0);
      setTimeout(sortWeekdays, 250);
    });
  } else {
    setTimeout(sortWeekdays, 0);
    setTimeout(sortWeekdays, 250);
  }
  
  // Für AJAX
  if (typeof jQuery !== 'undefined') {
    jQuery(document).ajaxComplete(function() {
      setTimeout(sortWeekdays, 0);
      setTimeout(sortWeekdays, 250);
    });
  }
})();
</script>
