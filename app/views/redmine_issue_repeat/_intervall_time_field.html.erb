<% 
  issue = defined?(issue) ? issue : (@issue if defined?(@issue))
  intervall_cf = IssueCustomField.find_by(name: 'Intervall')
  time_cf = IssueCustomField.find_by(name: 'Intervall Uhrzeit')
  cron_cf = IssueCustomField.find_by(name: 'Intervall Cron Syntax')
  return unless intervall_cf && time_cf && cron_cf
  
  intervall_cf_id = intervall_cf.id
  time_cf_id = time_cf.id
  cron_cf_id = cron_cf.id
  current_intervall = issue&.custom_field_values&.find { |cv| cv.custom_field_id == intervall_cf_id }&.value
  current_time = issue&.custom_field_values&.find { |cv| cv.custom_field_id == time_cf_id }&.value
  current_cron = issue&.custom_field_values&.find { |cv| cv.custom_field_id == cron_cf_id }&.value
%>

<script type="text/javascript">
(function() {
  function toggleTimeField() {
    var intervallField = document.querySelector('select[name*="[custom_field_values][<%= intervall_cf_id %>]"], input[name*="[custom_field_values][<%= intervall_cf_id %>]"]');
    var timeFieldRow = null;
    var cronFieldRow = null;
    var timeInput = null;
    var cronInput = null;
    
    // Finde das Zeit-Feld-Element
    var allRows = document.querySelectorAll('tr.issue_custom_field_<%= time_cf_id %>');
    if (allRows.length > 0) {
      timeFieldRow = allRows[0];
    }
    
    // Finde das Cron-Feld-Element
    var cronRows = document.querySelectorAll('tr.issue_custom_field_<%= cron_cf_id %>');
    if (cronRows.length > 0) {
      cronFieldRow = cronRows[0];
    }
    
    if (!intervallField) return;
    
    if (!timeFieldRow || !cronFieldRow) {
      // Fallback: Suche nach den Labels
      var labels = document.querySelectorAll('label');
      labels.forEach(function(label) {
        if (label.textContent && label.textContent.includes('Intervall Uhrzeit')) {
          timeFieldRow = label.closest('tr') || label.closest('p') || label.closest('div');
        }
        if (label.textContent && label.textContent.includes('Intervall Cron Syntax')) {
          cronFieldRow = label.closest('tr') || label.closest('p') || label.closest('div');
        }
      });
    }
    
    if (!timeFieldRow || !cronFieldRow) return;
    
    // Finde die Input-Felder
    timeInput = timeFieldRow.querySelector('input[type="text"], input[type="time"], input[name*="[custom_field_values][<%= time_cf_id %>]"]');
    cronInput = cronFieldRow.querySelector('input[type="text"], input[name*="[custom_field_values][<%= cron_cf_id %>]"]');
    
    function formatTimeInput(input) {
      if (!input) return;
      
      // Setze Platzhalter und Typ
      if (input.type === 'text') {
        input.placeholder = 'HH:MM (z.B. 14:30)';
        input.pattern = '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$';
        input.maxLength = 5;
        
        // Formatierung beim Eingeben
        input.addEventListener('input', function(e) {
          var value = e.target.value.replace(/[^\d:]/g, '');
          // Automatisches Einfügen von Doppelpunkt nach 2 Ziffern
          if (value.length === 2 && !value.includes(':')) {
            value = value + ':';
          }
          e.target.value = value;
        });
        
        // Validierung beim Verlassen des Feldes
        input.addEventListener('blur', function(e) {
          var value = e.target.value.trim();
          if (value && !value.match(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/)) {
            // Versuche zu korrigieren
            var parts = value.split(':');
            if (parts.length === 2) {
              var hours = parseInt(parts[0]) || 0;
              var minutes = parseInt(parts[1]) || 0;
              hours = Math.max(0, Math.min(23, hours));
              minutes = Math.max(0, Math.min(59, minutes));
              e.target.value = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
            } else {
              alert('Bitte geben Sie die Uhrzeit im Format HH:MM ein (z.B. 14:30)');
            }
          }
        });
      }
    }
    
    function formatCronInput(input) {
      if (!input) return;
      
      if (input.type === 'text') {
        input.placeholder = 'minute hour day month weekday (z.B. 0 3 * * *)';
        input.title = 'Cron-Syntax: minute hour day month weekday\nBeispiele:\n0 3 * * * = täglich um 3:00\n0 3 * * 1 = jeden Montag um 3:00\n0 */2 * * * = alle 2 Stunden\n0 3 1 * * = jeden Monat am 1. Tag um 3:00';
        
        // Validierung beim Verlassen des Feldes
        input.addEventListener('blur', function(e) {
          var value = e.target.value.trim();
          if (value && !validateCronSyntax(value)) {
            alert('Ungültige Cron-Syntax. Format: minute hour day month weekday\nBeispiele:\n0 3 * * * = täglich um 3:00\n0 3 * * 1 = jeden Montag um 3:00');
          }
        });
      }
    }
    
    function validateCronSyntax(cron) {
      // Einfache Validierung: 5 Teile getrennt durch Leerzeichen
      var parts = cron.trim().split(/\s+/);
      if (parts.length !== 5) return false;
      
      // Validiere jeden Teil
      var validPattern = /^(\*|\d+(-\d+)?(,\d+(-\d+)?)*|\*\/\d+)$/;
      return parts.every(function(part) {
        return validPattern.test(part);
      });
    }
    
    function updateVisibility() {
      var value = intervallField.value || '';
      var normalizedValue = value.toLowerCase().trim();
      
      // Zeige Uhrzeit-Feld bei stündlich, täglich, wöchentlich, monatlich
      var showTimeField = normalizedValue === 'stündlich' || 
                          normalizedValue === 'täglich' || 
                          normalizedValue === 'wöchentlich' || 
                          normalizedValue === 'monatlich';
      
      // Zeige Cron-Feld bei custom
      var showCronField = normalizedValue === 'custom';
      
      // Uhrzeit-Feld
      if (showTimeField) {
        timeFieldRow.style.display = '';
        // Formatiere das Input-Feld
        if (timeInput) {
          formatTimeInput(timeInput);
        } else {
          setTimeout(function() {
            timeInput = timeFieldRow.querySelector('input[type="text"], input[type="time"], input[name*="[custom_field_values][<%= time_cf_id %>]"]');
            if (timeInput) formatTimeInput(timeInput);
          }, 100);
        }
      } else {
        timeFieldRow.style.display = 'none';
      }
      
      // Cron-Feld
      if (showCronField) {
        cronFieldRow.style.display = '';
        // Formatiere das Input-Feld
        if (cronInput) {
          formatCronInput(cronInput);
        } else {
          setTimeout(function() {
            cronInput = cronFieldRow.querySelector('input[type="text"], input[name*="[custom_field_values][<%= cron_cf_id %>]"]');
            if (cronInput) formatCronInput(cronInput);
          }, 100);
        }
      } else {
        cronFieldRow.style.display = 'none';
      }
    }
    
    // Initiale Sichtbarkeit setzen
    updateVisibility();
    
    // Event Listener hinzufügen
    intervallField.addEventListener('change', updateVisibility);
    
    // Für AJAX-Updates (wenn das Formular dynamisch aktualisiert wird)
    if (typeof jQuery !== 'undefined') {
      jQuery(document).on('change', 'select[name*="[custom_field_values][<%= intervall_cf_id %>]"], input[name*="[custom_field_values][<%= intervall_cf_id %>]"]', updateVisibility);
    }
  }
  
  // Warte bis DOM bereit ist
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', toggleTimeField);
  } else {
    toggleTimeField();
  }
  
  // Für AJAX-Updates
  if (typeof jQuery !== 'undefined') {
    jQuery(document).ajaxComplete(function() {
      setTimeout(toggleTimeField, 100);
    });
  }
})();
</script>

