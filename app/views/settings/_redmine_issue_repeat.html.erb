<% settings = Setting.plugin_redmine_issue_repeat || {} %>
<p>
  <label>Uhrzeit täglich (HH:MM)</label>
  <%= text_field_tag 'settings[daily_time]', settings['daily_time'] %>
</p>
<p>
  <label>Uhrzeit wöchentlich (HH:MM)</label>
  <%= text_field_tag 'settings[weekly_time]', settings['weekly_time'] %>
</p>
<p>
  <label>Uhrzeit monatlich (HH:MM)</label>
  <%= text_field_tag 'settings[monthly_time]', settings['monthly_time'] %>
</p>
<p>
  <label>Minuten bei stündlich (0–59, 0 = volle Stunde)</label>
  <%= number_field_tag 'settings[hourly_minute]', (settings['hourly_minute'] || '0'), in: 0..59 %>
</p>

<h3>Aktive Wiederholungen</h3>
<% cf = IssueCustomField.find_by(name: 'Intervall') %>
<% issues = [] %>
<% if cf %>
  <% CustomValue.where(customized_type: 'Issue', custom_field_id: cf.id).where.not(value: [nil, '']).pluck(:customized_id).each do |iid| %>
    <% issue = Issue.where(id: iid).first %>
    <% issues << issue if issue %>
  <% end %>
<% end %>

<table class="list issues">
  <thead>
    <tr>
      <th>ID</th>
      <th>Projekt</th>
      <th>Betreff</th>
      <th>Intervall</th>
      <th>Nächste Erstellung</th>
      <th>Aktiv</th>
      <th>Times Run</th>
      <th>Aktion</th>
    </tr>
  </thead>
  <tbody>
  <% issues.each do |issue| %>
    <% interval = RedmineIssueRepeat::Scheduler.interval_value(issue) %>
    <% sched = RedmineIssueRepeat::IssueRepeatSchedule.where(issue_id: issue.id).first %>
    <% next_run = (sched && sched.next_run_at) || RedmineIssueRepeat::Scheduler.next_run_for(issue, base_time: Time.current) %>
    <tr>
      <td><%= link_to issue.id, issue_path(issue) %></td>
      <td><%= issue.project.try(:name) %></td>
      <td><%= h(issue.subject) %></td>
      <td><%= h(interval) %></td>
      <td><%= next_run ? format_time(next_run) : '-' %></td>
      <td><%= sched ? (sched.active ? 'ja' : 'nein') : 'ja' %></td>
      <td><%= sched ? sched.times_run : 0 %></td>
      <td>
        <%= button_to 'Jetzt wiederholen', redmine_issue_repeat_repeat_now_issue_path(issue), method: :post, data: { confirm: 'Sofort eine Kopie erstellen?' } %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>
