<% 
  issue = defined?(issue) ? issue : (@issue if defined?(@issue))
  intervall_cf = IssueCustomField.find_by(name: 'Intervall')
  time_cf = IssueCustomField.find_by(name: 'Intervall Uhrzeit')
  return unless intervall_cf && time_cf
  
  intervall_cf_id = intervall_cf.id
  time_cf_id = time_cf.id
  current_intervall = issue&.custom_field_values&.find { |cv| cv.custom_field_id == intervall_cf_id }&.value
  current_time = issue&.custom_field_values&.find { |cv| cv.custom_field_id == time_cf_id }&.value
%>

<script type="text/javascript">
(function() {
  function toggleTimeField() {
    var intervallField = document.querySelector('select[name*="[custom_field_values][<%= intervall_cf_id %>]"], input[name*="[custom_field_values][<%= intervall_cf_id %>]"]');
    var timeFieldRow = null;
    var timeInput = null;
    
    // Finde das Zeit-Feld-Element
    var allRows = document.querySelectorAll('tr.issue_custom_field_<%= time_cf_id %>');
    if (allRows.length > 0) {
      timeFieldRow = allRows[0];
    }
    
    if (!intervallField || !timeFieldRow) {
      // Fallback: Suche nach dem Label
      var labels = document.querySelectorAll('label');
      labels.forEach(function(label) {
        if (label.textContent && label.textContent.includes('Intervall Uhrzeit')) {
          timeFieldRow = label.closest('tr') || label.closest('p') || label.closest('div');
        }
      });
    }
    
    if (!intervallField || !timeFieldRow) return;
    
    // Finde das Input-Feld für die Uhrzeit
    timeInput = timeFieldRow.querySelector('input[type="text"], input[type="time"], input[name*="[custom_field_values][<%= time_cf_id %>]"]');
    
    function formatTimeInput(input) {
      if (!input) return;
      
      // Setze Platzhalter und Typ
      if (input.type === 'text') {
        input.placeholder = 'HH:MM (z.B. 14:30)';
        input.pattern = '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$';
        input.maxLength = 5;
        
        // Formatierung beim Eingeben
        input.addEventListener('input', function(e) {
          var value = e.target.value.replace(/[^\d:]/g, '');
          // Automatisches Einfügen von Doppelpunkt nach 2 Ziffern
          if (value.length === 2 && !value.includes(':')) {
            value = value + ':';
          }
          e.target.value = value;
        });
        
        // Validierung beim Verlassen des Feldes
        input.addEventListener('blur', function(e) {
          var value = e.target.value.trim();
          if (value && !value.match(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/)) {
            // Versuche zu korrigieren
            var parts = value.split(':');
            if (parts.length === 2) {
              var hours = parseInt(parts[0]) || 0;
              var minutes = parseInt(parts[1]) || 0;
              hours = Math.max(0, Math.min(23, hours));
              minutes = Math.max(0, Math.min(59, minutes));
              e.target.value = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
            } else {
              alert('Bitte geben Sie die Uhrzeit im Format HH:MM ein (z.B. 14:30)');
            }
          }
        });
      }
    }
    
    function updateVisibility() {
      var value = intervallField.value || '';
      var normalizedValue = value.toLowerCase().trim();
      if (normalizedValue === 'täglich') {
        timeFieldRow.style.display = '';
        // Stelle sicher, dass das Feld sichtbar ist
        if (timeFieldRow.style.display === 'none') {
          timeFieldRow.style.display = '';
        }
        // Formatiere das Input-Feld
        if (timeInput) {
          formatTimeInput(timeInput);
        } else {
          // Versuche das Feld erneut zu finden
          setTimeout(function() {
            timeInput = timeFieldRow.querySelector('input[type="text"], input[type="time"], input[name*="[custom_field_values][<%= time_cf_id %>]"]');
            if (timeInput) formatTimeInput(timeInput);
          }, 100);
        }
      } else {
        timeFieldRow.style.display = 'none';
      }
    }
    
    // Initiale Sichtbarkeit setzen
    updateVisibility();
    
    // Event Listener hinzufügen
    intervallField.addEventListener('change', updateVisibility);
    
    // Für AJAX-Updates (wenn das Formular dynamisch aktualisiert wird)
    if (typeof jQuery !== 'undefined') {
      jQuery(document).on('change', 'select[name*="[custom_field_values][<%= intervall_cf_id %>]"], input[name*="[custom_field_values][<%= intervall_cf_id %>]"]', updateVisibility);
    }
  }
  
  // Warte bis DOM bereit ist
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', toggleTimeField);
  } else {
    toggleTimeField();
  }
  
  // Für AJAX-Updates
  if (typeof jQuery !== 'undefined') {
    jQuery(document).ajaxComplete(function() {
      setTimeout(toggleTimeField, 100);
    });
  }
})();
</script>

