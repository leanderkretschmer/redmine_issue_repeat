<% 
  issue = defined?(issue) ? issue : (@issue if defined?(@issue))
  intervall_cf = IssueCustomField.find_by(name: 'Intervall')
  time_cf = IssueCustomField.find_by(name: 'Intervall Uhrzeit')
  weekday_cf = IssueCustomField.find_by(name: 'Intervall Wochentag')
  monthday_cf = IssueCustomField.find_by(name: 'Intervall Monatstag')
  return unless intervall_cf && time_cf
  
  intervall_cf_id = intervall_cf.id
  time_cf_id = time_cf.id
  weekday_cf_id = weekday_cf&.id
  monthday_cf_id = monthday_cf&.id
  current_intervall = issue&.custom_field_values&.find { |cv| cv.custom_field_id == intervall_cf_id }&.value
  current_time = issue&.custom_field_values&.find { |cv| cv.custom_field_id == time_cf_id }&.value
%>

<script type="text/javascript">
(function() {
  var weekdayFieldRow = null;
  
  // Funktion zum Ersetzen des Multi-Select durch Checkboxen
  function replaceWeekdaySelectWithCheckboxes() {
    <% if weekday_cf_id %>
    // Finde das Wochentag-Feld-Element falls noch nicht gefunden
    if (!weekdayFieldRow) {
      var weekdayRows = document.querySelectorAll('tr.issue_custom_field_<%= weekday_cf_id %>');
      if (weekdayRows.length > 0) {
        weekdayFieldRow = weekdayRows[0];
      } else {
        // Fallback: Suche nach dem Label
        var labels = document.querySelectorAll('label');
        labels.forEach(function(label) {
          if (label.textContent && label.textContent.includes('Intervall Wochentag')) {
            weekdayFieldRow = label.closest('tr') || label.closest('p') || label.closest('div');
          }
        });
      }
    }
    
    if (!weekdayFieldRow) return;
    
    // Prüfe ob bereits ersetzt wurde
    if (weekdayFieldRow.querySelector('.weekday-checkboxes-container')) return;
    
    // Finde das Select-Element
    var selectElement = weekdayFieldRow.querySelector('select[name*="[custom_field_values][<%= weekday_cf_id %>]"]');
    if (!selectElement) return;
    
    // Wochentage in der richtigen Reihenfolge
    var weekdays = [
      { value: 'Montag', label: 'Montag' },
      { value: 'Dienstag', label: 'Dienstag' },
      { value: 'Mittwoch', label: 'Mittwoch' },
      { value: 'Donnerstag', label: 'Donnerstag' },
      { value: 'Freitag', label: 'Freitag' },
      { value: 'Samstag', label: 'Samstag' },
      { value: 'Sonntag', label: 'Sonntag' }
    ];
    
    // Verstecke das Select-Element komplett (aber nicht löschen, damit die Werte beim Submit übertragen werden)
    selectElement.style.display = 'none';
    selectElement.style.visibility = 'hidden';
    selectElement.style.position = 'absolute';
    selectElement.style.left = '-9999px';
    
    // Finde die td-Zelle und passe das Layout an
    var tdCell = selectElement.closest('td');
    if (tdCell) {
      tdCell.style.verticalAlign = 'top';
      tdCell.style.position = 'relative';
    }
    
    // Erstelle Container für Checkboxen
    var container = document.createElement('div');
    container.className = 'weekday-checkboxes-container';
    container.style.marginTop = '5px';
    container.style.marginBottom = '5px';
    container.style.display = 'flex';
    container.style.flexWrap = 'wrap';
    container.style.gap = '15px';
    container.style.alignItems = 'center';
    container.style.width = '100%';
    
    // Erstelle Checkboxen
    weekdays.forEach(function(weekday) {
      var checkboxWrapper = document.createElement('label');
      checkboxWrapper.style.display = 'flex';
      checkboxWrapper.style.alignItems = 'center';
      checkboxWrapper.style.marginRight = '15px';
      checkboxWrapper.style.marginBottom = '5px';
      checkboxWrapper.style.cursor = 'pointer';
      checkboxWrapper.style.whiteSpace = 'nowrap';
      checkboxWrapper.style.flexShrink = '0';
      
      var checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = weekday.value;
      checkbox.name = 'custom_field_values[<%= weekday_cf_id %>][]';
      checkbox.id = 'weekday_<%= weekday_cf_id %>_' + weekday.value.toLowerCase();
      checkbox.style.marginRight = '5px';
      checkbox.style.flexShrink = '0';
      
      // Prüfe ob dieser Wochentag bereits ausgewählt ist
      var options = selectElement.querySelectorAll('option');
      options.forEach(function(option) {
        if (option.value === weekday.value && option.selected) {
          checkbox.checked = true;
        }
      });
      
      var label = document.createElement('span');
      label.textContent = weekday.label;
      label.style.userSelect = 'none';
      
      checkboxWrapper.appendChild(checkbox);
      checkboxWrapper.appendChild(label);
      container.appendChild(checkboxWrapper);
    });
    
    // Füge Container nach dem Select hinzu (oder ersetze den Select-Container)
    var selectParent = selectElement.parentNode;
    if (selectParent) {
      selectParent.insertBefore(container, selectElement.nextSibling);
    } else {
      selectElement.parentNode.insertBefore(container, selectElement.nextSibling);
    }
    
    // Funktion zum Synchronisieren der Checkboxen mit dem Select
    function syncCheckboxesToSelect() {
      var checkboxes = container.querySelectorAll('input[type="checkbox"]');
      var selectedValues = [];
      checkboxes.forEach(function(checkbox) {
        if (checkbox.checked) {
          selectedValues.push(checkbox.value);
        }
      });
      
      // Aktualisiere Select-Optionen
      var options = selectElement.querySelectorAll('option');
      options.forEach(function(option) {
        option.selected = selectedValues.indexOf(option.value) !== -1;
      });
      
      // Trigger Change-Event für Redmine
      if (typeof jQuery !== 'undefined') {
        jQuery(selectElement).trigger('change');
      } else {
        var event = new Event('change', { bubbles: true });
        selectElement.dispatchEvent(event);
      }
    }
    
    // Synchronisiere Checkboxen mit Select beim Ändern
    container.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox') {
        syncCheckboxesToSelect();
      }
    });
    <% end %>
  }
  
  function toggleTimeField() {
    var intervallField = document.querySelector('select[name*="[custom_field_values][<%= intervall_cf_id %>]"], input[name*="[custom_field_values][<%= intervall_cf_id %>]"]');
    var timeFieldRow = null;
    var monthdayFieldRow = null;
    var timeInput = null;
    
    // Finde das Zeit-Feld-Element
    var allRows = document.querySelectorAll('tr.issue_custom_field_<%= time_cf_id %>');
    if (allRows.length > 0) {
      timeFieldRow = allRows[0];
    }
    
    // Finde das Wochentag-Feld-Element
    <% if weekday_cf_id %>
    var weekdayRows = document.querySelectorAll('tr.issue_custom_field_<%= weekday_cf_id %>');
    if (weekdayRows.length > 0) {
      weekdayFieldRow = weekdayRows[0];
    }
    <% end %>
    
    // Finde das Monatstag-Feld-Element
    <% if monthday_cf_id %>
    var monthdayRows = document.querySelectorAll('tr.issue_custom_field_<%= monthday_cf_id %>');
    if (monthdayRows.length > 0) {
      monthdayFieldRow = monthdayRows[0];
    }
    <% end %>
    
    if (!intervallField) return;
    
    if (!timeFieldRow) {
      // Fallback: Suche nach dem Label
      var labels = document.querySelectorAll('label');
      labels.forEach(function(label) {
        if (label.textContent && label.textContent.includes('Intervall Uhrzeit')) {
          timeFieldRow = label.closest('tr') || label.closest('p') || label.closest('div');
        }
        <% if weekday_cf_id %>
        if (label.textContent && label.textContent.includes('Intervall Wochentag')) {
          weekdayFieldRow = label.closest('tr') || label.closest('p') || label.closest('div');
        }
        <% end %>
        <% if monthday_cf_id %>
        if (label.textContent && label.textContent.includes('Intervall Monatstag')) {
          monthdayFieldRow = label.closest('tr') || label.closest('p') || label.closest('div');
        }
        <% end %>
      });
    }
    
    if (!timeFieldRow) return;
    
    // Finde die Input-Felder
    timeInput = timeFieldRow.querySelector('input[type="text"], input[type="time"], input[name*="[custom_field_values][<%= time_cf_id %>]"]');
    
    function formatTimeInput(input) {
      if (!input) return;
      
      // Setze Platzhalter und Typ
      if (input.type === 'text') {
        input.placeholder = 'HH:MM';
        input.pattern = '^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$';
        input.maxLength = 5;
        
        // Formatierung beim Eingeben
        input.addEventListener('input', function(e) {
          var value = e.target.value.replace(/[^\d:]/g, '');
          // Automatisches Einfügen von Doppelpunkt nach 2 Ziffern
          if (value.length === 2 && !value.includes(':')) {
            value = value + ':';
          }
          e.target.value = value;
        });
        
        // Validierung beim Verlassen des Feldes
        input.addEventListener('blur', function(e) {
          var value = e.target.value.trim();
          if (value && !value.match(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/)) {
            // Versuche zu korrigieren
            var parts = value.split(':');
            if (parts.length === 2) {
              var hours = parseInt(parts[0]) || 0;
              var minutes = parseInt(parts[1]) || 0;
              hours = Math.max(0, Math.min(23, hours));
              minutes = Math.max(0, Math.min(59, minutes));
              e.target.value = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
            } else {
              alert('Bitte geben Sie die Uhrzeit im Format HH:MM ein (z.B. 14:30)');
            }
          }
        });
      }
    }
    
    function updateVisibility() {
      var value = intervallField.value || '';
      var normalizedValue = value.toLowerCase().trim();
      
      // Zeige Uhrzeit-Feld bei stündlich, täglich, wöchentlich, monatlich
      var showTimeField = normalizedValue === 'stündlich' || 
                          normalizedValue === 'täglich' || 
                          normalizedValue === 'wöchentlich' || 
                          normalizedValue === 'monatlich';
      
      // Zeige Wochentag-Feld bei wöchentlich
      var showWeekdayField = normalizedValue === 'wöchentlich';
      
      // Zeige Monatstag-Feld bei monatlich
      var showMonthdayField = normalizedValue === 'monatlich';
      
      // Uhrzeit-Feld
      if (showTimeField) {
        timeFieldRow.style.display = '';
        // Formatiere das Input-Feld
        if (timeInput) {
          formatTimeInput(timeInput);
        } else {
          setTimeout(function() {
            timeInput = timeFieldRow.querySelector('input[type="text"], input[type="time"], input[name*="[custom_field_values][<%= time_cf_id %>]"]');
            if (timeInput) formatTimeInput(timeInput);
          }, 100);
        }
      } else {
        timeFieldRow.style.display = 'none';
      }
      
      // Wochentag-Feld
      <% if weekday_cf_id %>
      if (weekdayFieldRow) {
        if (showWeekdayField) {
          weekdayFieldRow.style.display = '';
          // Ersetze Multi-Select durch Checkboxen
          replaceWeekdaySelectWithCheckboxes();
        } else {
          weekdayFieldRow.style.display = 'none';
        }
      }
      <% end %>
      
      // Monatstag-Feld
      <% if monthday_cf_id %>
      if (monthdayFieldRow) {
        if (showMonthdayField) {
          monthdayFieldRow.style.display = '';
        } else {
          monthdayFieldRow.style.display = 'none';
        }
      }
      <% end %>
    }
    
    // Initiale Sichtbarkeit setzen
    updateVisibility();
    
    // Event Listener hinzufügen
    intervallField.addEventListener('change', updateVisibility);
    
    // Für AJAX-Updates (wenn das Formular dynamisch aktualisiert wird)
    if (typeof jQuery !== 'undefined') {
      jQuery(document).on('change', 'select[name*="[custom_field_values][<%= intervall_cf_id %>]"], input[name*="[custom_field_values][<%= intervall_cf_id %>]"]', updateVisibility);
    }
  }
  
  // Warte bis DOM bereit ist
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      toggleTimeField();
      // Prüfe initial ob wöchentlich bereits ausgewählt ist
      setTimeout(function() {
        <% if weekday_cf_id %>
        var intervallField = document.querySelector('select[name*="[custom_field_values][<%= intervall_cf_id %>]"], input[name*="[custom_field_values][<%= intervall_cf_id %>]"]');
        if (intervallField && intervallField.value && intervallField.value.toLowerCase().trim() === 'wöchentlich') {
          replaceWeekdaySelectWithCheckboxes();
        }
        <% end %>
      }, 200);
    });
  } else {
    toggleTimeField();
    // Prüfe initial ob wöchentlich bereits ausgewählt ist
    setTimeout(function() {
      <% if weekday_cf_id %>
      var intervallField = document.querySelector('select[name*="[custom_field_values][<%= intervall_cf_id %>]"], input[name*="[custom_field_values][<%= intervall_cf_id %>]"]');
      if (intervallField && intervallField.value && intervallField.value.toLowerCase().trim() === 'wöchentlich') {
        replaceWeekdaySelectWithCheckboxes();
      }
      <% end %>
    }, 200);
  }
  
  // Für AJAX-Updates
  if (typeof jQuery !== 'undefined') {
    jQuery(document).ajaxComplete(function() {
      setTimeout(function() {
        toggleTimeField();
        <% if weekday_cf_id %>
        // Prüfe nach AJAX-Update ob Checkboxen erstellt werden müssen
        var intervallField = document.querySelector('select[name*="[custom_field_values][<%= intervall_cf_id %>]"], input[name*="[custom_field_values][<%= intervall_cf_id %>]"]');
        if (intervallField && intervallField.value && intervallField.value.toLowerCase().trim() === 'wöchentlich') {
          weekdayFieldRow = null; // Reset für erneutes Finden
          replaceWeekdaySelectWithCheckboxes();
        }
        <% end %>
      }, 100);
    });
  }
})();
</script>

