<% settings = Setting.plugin_redmine_issue_repeat || {} %>
<p>
  <label>Uhrzeit täglich (HH:MM)</label>
  <%= text_field_tag 'settings[daily_time]', settings['daily_time'] %>
</p>
<p>
  <label>Uhrzeit wöchentlich (HH:MM)</label>
  <%= text_field_tag 'settings[weekly_time]', settings['weekly_time'] %>
</p>
<p>
  <label>Uhrzeit monatlich (HH:MM)</label>
  <%= text_field_tag 'settings[monthly_time]', settings['monthly_time'] %>
</p>
<p>
  <label>Zeitzone (z. B. UTC, Europe/Berlin, UTC+1)</label>
  <%= text_field_tag 'settings[time_zone]', (settings['time_zone'].presence || 'UTC'), placeholder: 'UTC' %>
  <br/>
  <em>Bestimmt die Interpretation der Uhrzeiten für Wiederholungen.</em>
  </p>
<p>
  <label>Minuten bei stündlich (0–59, 0 = volle Stunde)</label>
  <%= number_field_tag 'settings[hourly_minute]', (settings['hourly_minute'] || '0'), in: 0..59 %>
</p>

<p>
  <label>Hintergrundfarbe für Kopie-Tickets (CSS-Farbe oder Hex)</label>
  <%= text_field_tag 'settings[copy_issue_bg_color]', (settings['copy_issue_bg_color'] || '#fffbe6'), placeholder: '#fffbe6' %>
  <br/>
  <em>Beispiel: #ffd966, rgb(255,217,102) oder "lightyellow"</em>
</p>

<p>
  <%= check_box_tag 'settings[add_prefix_to_copied_issues]', '1', (settings['add_prefix_to_copied_issues'] == '1' || settings['add_prefix_to_copied_issues'] == true) %>
  <label for="settings_add_prefix_to_copied_issues">Präfix vor kopierte Ticket-Namen setzen</label>
</p>

<p>
  <label>Präfix-Zeichen für kopierte Tickets</label>
  <%= text_field_tag 'settings[copied_issue_prefix]', (settings['copied_issue_prefix'].presence || '➚'), placeholder: '➚' %>
  <br/>
  <em>Das Zeichen wird mit einem Leerzeichen vor dem Ticket-Namen gesetzt (z.B. ➚ Ticketname)</em>
</p>

<h3>Wiederholungs-Zeitpläne</h3>
<% if ActiveRecord::Base.connection.table_exists?('issue_repeat_schedules') %>
  <table class="list">
    <thead>
      <tr>
        <th>id</th>
        <th>issue_id</th>
        <th>intervall</th>
        <th>created_at</th>
        <th>updated_at</th>
        <th>times_run</th>
        <th>active</th>
        <th>anchor_minute</th>
        <th>anchor_hour</th>
        <th>anchor_day</th>
        <th>backup_anchor_day</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody>
    <% RedmineIssueRepeat::IssueRepeatSchedule.order('id ASC').each do |s| %>
      <tr>
        <td><%= s.id %></td>
        <td><%= s.issue_id %></td>
        <td><%= h(s.interval) %></td>
        <td><%= format_time(s.created_at) %></td>
        <td><%= format_time(s.updated_at) %></td>
        <td><%= s.times_run %></td>
        <td><%= s.active ? 'ja' : 'nein' %></td>
        <td><%= s.anchor_minute %></td>
        <td><%= s.anchor_hour %></td>
        <td><%= s.anchor_day %></td>
        <td><%= s.backup_anchor_day %></td>
        <td>
          <%= link_to 'Jetzt wiederholen', redmine_issue_repeat_repeat_now_issue_path(s.issue_id), data: { confirm: 'Sofort eine Kopie erstellen?' } %>
        </td>
      </tr>
    <% end %>
    </tbody>
    </table>
<% elsif ActiveRecord::Base.connection.table_exists?('issue_repeat_entries') %>
  <table class="list">
    <thead>
      <tr>
        <th>id</th>
        <th>ticket_id</th>
        <th>ticket_title</th>
        <th>intervall</th>
        <th>intervall_state</th>
        <th>times_run</th>
        <th>next_run</th>
        <th>last_run</th>
        <th>intervall_hour</th>
        <th>intervall_weekday</th>
        <th>intervall_monthday</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody>
    <% RedmineIssueRepeat::IssueRepeatEntry.order('id ASC').each do |e| %>
      <tr>
        <td><%= e.id %></td>
        <td><%= e.ticket_id %></td>
        <td><%= h(e.ticket_title) %></td>
        <td><%= h(e.intervall) %></td>
        <td><%= e.intervall_state ? 'ja' : 'nein' %></td>
        <td><%= e.times_run %></td>
        <td><%= e.next_run ? format_time(Time.at(e.next_run)) : '-' %></td>
        <td><%= e.last_run ? format_time(Time.at(e.last_run)) : '-' %></td>
        <td><%= e.intervall_hour %></td>
        <td><%= e.intervall_weekday %></td>
        <td><%= e.intervall_monthday %></td>
        <td>
          <%= link_to 'Jetzt wiederholen', redmine_issue_repeat_repeat_now_issue_path(e.ticket_id), data: { confirm: 'Sofort eine Kopie erstellen?' } %>
        </td>
      </tr>
    <% end %>
    </tbody>
    </table>
<% else %>
  <p><em>Keine Schedules- oder Entries-Tabelle gefunden. Bitte Plugin-Migrationen ausführen.</em></p>
<% end %>
